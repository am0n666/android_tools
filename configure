#!/bin/bash
#
# configure script for android_img_repack_tools.
#
BRANCH=android-6.0.1_r22
BRANCH_EXT=cm-13.0
FILE=sepolicy/file_contexts
FILE1=extras/ext4_utils/mkuserimg.sh
FILE2=core/libsparse/defs.h
FILE3=core/libsparse/img2simg.c
FILE4=extras/ext4_utils/ext4_sb.h
FILE5=core/libsparse/output_file.c
FILE6=core/libsparse/append2simg.c
FILE7=core/libsparse/simg_dump.py


get_src() {
	git clone $1
}
checkout() {
	git checkout $BRANCH
}
checkout_external() {
	git checkout $BRANCH_EXT
}
edit_text() {
	sed -i $1 $2
}

mkdir external

get_src https://android.googlesource.com/platform/external/sepolicy/
	cd sepolicy
	checkout
	cd ..
get_src https://android.googlesource.com/platform/system/core
	cd core
	checkout
	cd ..
get_src https://android.googlesource.com/platform/system/extras
	cd extras
	checkout
	cd ..
get_src https://android.googlesource.com/platform/external/libselinux
	cd libselinux
	checkout
	cd ..
get_src https://android.googlesource.com/platform/bionic
	cd bionic
	checkout
	cd ..
get_src https://android.googlesource.com/platform/external/pcre
	cd pcre
	checkout
	cd ..
get_src https://android.googlesource.com/platform/external/zlib
	cd zlib
	checkout
	cd ../external
get_src https://github.com/CyanogenMod/android_system_core.git
	cd android_system_core
	checkout_external
	cd ..
get_src https://github.com/Chainfire/sgs4ext4fs
    cd ..



echo
echo "for android.googlesource.com choosed branch $BRANCH..."
echo
echo "for Cyanogen Mod source choosed branch $BRANCH_EXT..."
echo
cd pcre/dist
./configure && make
cd ../../zlib/src
./configure && make
cd ../..

echo Patch files
	
sed -i '/^/s:MAKE_EXT4FS_CMD="make_ext4fs:MAKE_EXT4FS_CMD="./make_ext4fs:' $FILE1

sed -i '15r USE_MINGW' $FILE2

sed -i '34r USE_MINGW' $FILE3

sed -i '15r USE_MINGW' $FILE4

sed -i '707a\#define USE_MINGW' $FILE5

sed -i '43r USE_MINGW' $FILE6



	cp -fv $FILE .
	cp -fv $FILE1 .
	cp -fv $FILE7 .
	
make
